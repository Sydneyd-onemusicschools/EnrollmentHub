<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --color-bg: #F5F5F7;
      --color-white: #FFFFFF;
      --color-coral: #F97B5F;
      --color-coral-dark: #E56A4F;
      --color-pink: #F472B6;
      --gradient-primary: linear-gradient(135deg, #F97B5F 0%, #F472B6 100%);
      --color-text: #1F2937;
      --color-text-muted: #6B7280;
      --color-text-light: #9CA3AF;
      --color-border: #E5E7EB;
      --color-success: #10B981;
      --color-warning: #F59E0B;
      --color-danger: #EF4444;
      --color-blue: #3B82F6;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --sidebar-width: 260px;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
      min-height: 100vh;
      line-height: 1.6;
    }

    .app-layout { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--color-white);
      border-right: 1px solid var(--color-border);
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      z-index: 100;
      transition: transform 0.3s ease;
    }

    .sidebar-header { padding: 20px; border-bottom: 1px solid var(--color-border); }

    .sidebar-logo { display: flex; align-items: center; gap: 12px; }

    .sidebar-logo-icon {
      width: 42px;
      height: 42px;
      background: var(--gradient-primary);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      flex-shrink: 0;
    }

    .sidebar-logo-text h1 { font-size: 15px; font-weight: 700; color: var(--color-text); }
    .sidebar-logo-text p { font-size: 11px; color: var(--color-text-muted); margin-top: 2px; }

    .sidebar-nav { flex: 1; padding: 16px 12px; overflow-y: auto; }

    .nav-section { margin-bottom: 20px; }
    .nav-section-title {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--color-text-light);
      padding: 0 12px;
      margin-bottom: 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      color: var(--color-text-muted);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      margin-bottom: 2px;
    }

    .nav-item:hover { background: var(--color-bg); color: var(--color-text); }
    .nav-item.active {
      background: linear-gradient(135deg, rgba(249, 123, 95, 0.12) 0%, rgba(244, 114, 182, 0.12) 100%);
      color: var(--color-coral);
    }
    .nav-item.active svg { color: var(--color-coral); }
    .nav-item svg { width: 18px; height: 18px; flex-shrink: 0; }

    .sidebar-footer { padding: 16px 20px; border-top: 1px solid var(--color-border); }

    .preview-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 10px 16px;
      background: var(--gradient-primary);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: opacity 0.15s;
    }

    .preview-btn:hover { opacity: 0.9; }

    /* Mobile Header */
    .mobile-header {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 56px;
      background: var(--color-white);
      border-bottom: 1px solid var(--color-border);
      padding: 0 16px;
      align-items: center;
      justify-content: space-between;
      z-index: 99;
    }

    .mobile-menu-btn {
      width: 40px; height: 40px;
      border: none;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text);
      border-radius: var(--radius-sm);
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 99;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 32px;
      min-height: 100vh;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 28px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .page-header-text h1 { font-size: 26px; font-weight: 700; margin-bottom: 6px; }
    .page-header-text p { font-size: 14px; color: var(--color-text-muted); }

    .section { display: none; }
    .section.active { display: block; animation: fadeIn 0.25s ease; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.15s ease;
      font-family: inherit;
    }

    .btn-primary { background: var(--gradient-primary); color: white; }
    .btn-primary:hover { opacity: 0.9; box-shadow: var(--shadow-md); }

    .btn-secondary {
      background: var(--color-white);
      color: var(--color-text);
      border: 1px solid var(--color-border);
    }
    .btn-secondary:hover { background: var(--color-bg); }

    .btn-danger { background: var(--color-danger); color: white; }
    .btn-danger:hover { background: #DC2626; }

    .btn-sm { padding: 6px 12px; font-size: 13px; }

    .btn-icon {
      width: 36px; height: 36px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--color-white);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      color: var(--color-text-muted);
      cursor: pointer;
    }

    .btn-icon:hover { background: var(--color-bg); color: var(--color-text); }
    .btn-icon.danger:hover { background: rgba(239, 68, 68, 0.1); color: var(--color-danger); border-color: var(--color-danger); }

    /* Cards */
    .card {
      background: var(--color-white);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--color-border);
    }

    /* Data Table */
    .data-table { width: 100%; border-collapse: collapse; }

    .data-table th {
      text-align: left;
      padding: 12px 16px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--color-text-muted);
      border-bottom: 2px solid var(--color-border);
      background: var(--color-bg);
    }

    .data-table td {
      padding: 14px 16px;
      font-size: 14px;
      border-bottom: 1px solid var(--color-border);
      vertical-align: middle;
    }

    .data-table tr:hover td { background: rgba(249, 123, 95, 0.03); }

    .data-table .drag-handle {
      cursor: grab;
      color: var(--color-text-light);
      padding-right: 8px;
    }

    .data-table .drag-handle:active { cursor: grabbing; }
    .data-table .actions { display: flex; gap: 8px; justify-content: flex-end; }

    /* Status Badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge.active { background: rgba(16, 185, 129, 0.1); color: var(--color-success); }
    .status-badge.inactive { background: rgba(107, 114, 128, 0.1); color: var(--color-text-muted); }
    .status-badge.upcoming { background: rgba(59, 130, 246, 0.1); color: var(--color-blue); }
    .status-badge.ended { background: rgba(107, 114, 128, 0.1); color: var(--color-text-muted); }

    /* Avatar */
    .avatar {
      width: 40px; height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--color-bg);
    }

    .avatar-sm { width: 32px; height: 32px; }

    /* Zone Badge */
    .zone-badge {
      display: inline-block;
      padding: 3px 10px;
      background: var(--color-bg);
      border-radius: 12px;
      font-size: 12px;
      color: var(--color-text-muted);
      font-weight: 500;
    }

    /* Form Elements */
    .form-group { margin-bottom: 20px; }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 6px;
    }

    .form-group .hint {
      font-size: 12px;
      color: var(--color-text-muted);
      margin-top: 4px;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-family: inherit;
      background: var(--color-white);
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--color-coral);
      box-shadow: 0 0 0 3px rgba(249, 123, 95, 0.1);
    }

    .form-textarea { resize: vertical; min-height: 100px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-switch { display: flex; align-items: center; gap: 10px; }

    .switch { position: relative; width: 44px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }

    .switch-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: var(--color-border);
      border-radius: 24px;
      transition: 0.2s;
    }

    .switch-slider:before {
      content: '';
      position: absolute;
      width: 18px; height: 18px;
      left: 3px; bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: 0.2s;
      box-shadow: var(--shadow-sm);
    }

    .switch input:checked + .switch-slider { background: var(--color-success); }
    .switch input:checked + .switch-slider:before { transform: translateX(20px); }

    /* Avatar Upload */
    .avatar-upload { display: flex; align-items: center; gap: 16px; }

    .avatar-preview {
      width: 80px; height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--color-bg);
      background: var(--color-bg);
    }

    .avatar-actions { display: flex; flex-direction: column; gap: 8px; }

    /* Rich Text Editor */
    .editor-toolbar {
      display: flex;
      gap: 4px;
      padding: 10px;
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-bottom: none;
      border-radius: var(--radius-sm) var(--radius-sm) 0 0;
      flex-wrap: wrap;
    }

    .editor-btn {
      width: 32px; height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--color-white);
      border: 1px solid var(--color-border);
      border-radius: 4px;
      cursor: pointer;
      color: var(--color-text-muted);
      font-size: 12px;
      font-weight: 600;
      transition: all 0.15s;
    }

    .editor-btn:hover { background: var(--color-coral); color: white; border-color: var(--color-coral); }

    .editor-content {
      min-height: 300px;
      padding: 16px;
      border: 1px solid var(--color-border);
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
      font-size: 14px;
      line-height: 1.7;
      background: var(--color-white);
    }

    .editor-content:focus { outline: none; border-color: var(--color-coral); }
    .editor-content h2 { font-size: 18px; margin: 16px 0 8px; color: var(--color-coral); }
    .editor-content h3 { font-size: 16px; margin: 14px 0 6px; }
    .editor-content p { margin-bottom: 12px; }
    .editor-content ul, .editor-content ol { padding-left: 24px; margin: 12px 0; }
    .editor-content li { margin-bottom: 6px; }
    .editor-content blockquote {
      background: linear-gradient(135deg, rgba(249, 123, 95, 0.08) 0%, rgba(244, 114, 182, 0.08) 100%);
      border-left: 4px solid var(--color-coral);
      padding: 12px 16px;
      margin: 12px 0;
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      font-style: italic;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      padding: 20px;
    }

    .modal-overlay.active { opacity: 1; visibility: visible; }

    .modal {
      background: var(--color-white);
      border-radius: var(--radius-lg);
      max-width: 560px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.95);
      transition: all 0.2s ease;
    }

    .modal-overlay.active .modal { transform: scale(1); }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 { font-size: 18px; font-weight: 600; }

    .modal-close {
      width: 32px; height: 32px;
      border: none;
      background: var(--color-bg);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-muted);
      transition: all 0.15s ease;
    }

    .modal-close:hover { background: var(--color-coral); color: white; }

    .modal-body { padding: 24px; }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--color-border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--color-text-muted);
    }

    .empty-state svg { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.4; }
    .empty-state h3 { font-size: 16px; font-weight: 600; margin-bottom: 6px; color: var(--color-text); }
    .empty-state p { font-size: 14px; margin-bottom: 20px; }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px; right: 24px;
      background: var(--color-text);
      color: white;
      padding: 14px 20px;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: var(--shadow-lg);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 2000;
    }

    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background: var(--color-success); }
    .toast.error { background: var(--color-danger); }

    /* Connection Status */
    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--color-bg);
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 12px;
    }

    .connection-dot { width: 8px; height: 8px; border-radius: 50%; }
    .connection-dot.connected { background: var(--color-success); }
    .connection-dot.disconnected { background: var(--color-warning); }

    /* Mobile Responsive */
    @media (max-width: 1024px) {
      .form-row { grid-template-columns: 1fr; }
    }

    @media (max-width: 768px) {
      .mobile-header { display: flex; }
      .sidebar { transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
      .sidebar-overlay.open { display: block; }
      .main-content { margin-left: 0; padding: 72px 16px 32px; }
      .page-header { flex-direction: column; align-items: stretch; }
      .data-table { font-size: 13px; }
      .data-table th, .data-table td { padding: 10px 12px; }
      .modal { margin: 16px; }
    }
  </style>
</head>
<body>
  <div class="mobile-header">
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>
    <span style="font-size: 15px; font-weight: 700;">Admin Portal</span>
    <div style="width: 40px;"></div>
  </div>

  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <div class="app-layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
          </div>
          <div class="sidebar-logo-text">
            <h1>Admin Portal</h1>
            <p>Manage Content</p>
          </div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Content</div>
          <a class="nav-item active" onclick="switchSection('announcements')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m3 11 18-5v12L3 13v-2z"></path><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"></path></svg>
            Announcements
          </a>
          <a class="nav-item" onclick="switchSection('promos')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="6"></circle><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"></path></svg>
            Promotions
          </a>
          <a class="nav-item" onclick="switchSection('policies')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
            Policies
          </a>
          <a class="nav-item" onclick="switchSection('links')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
            Resources
          </a>
          <a class="nav-item" onclick="switchSection('script')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path></svg>
            Enrollment Script
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Team</div>
          <a class="nav-item" onclick="switchSection('team')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            Team Members
          </a>
          <a class="nav-item" onclick="switchSection('zones')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><circle cx="12" cy="10" r="3"></circle></svg>
            Zones
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <a href="director-dashboard.html" target="_blank" class="preview-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
          Preview Director Portal
        </a>
      </div>
    </aside>

    <main class="main-content">
      <!-- Announcements Section -->
      <section id="announcements" class="section active">
        <div class="page-header">
          <div class="page-header-text">
            <h1>Announcements</h1>
            <p>Manage announcements displayed on the director dashboard.</p>
          </div>
          <button class="btn btn-primary" onclick="openAnnouncementModal()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Add Announcement
          </button>
        </div>
        <div class="connection-status">
          <div class="connection-dot" id="connectionDot"></div>
          <span id="connectionText">Checking connection...</span>
        </div>
        <div class="card">
          <table class="data-table"><thead><tr>
            <th style="width: 40px;"></th><th>Title</th><th>Date</th><th>Status</th><th style="width: 120px; text-align: right;">Actions</th>
          </tr></thead><tbody id="announcementsList"></tbody></table>
        </div>
      </section>

      <!-- Promos Section -->
      <section id="promos" class="section">
        <div class="page-header">
          <div class="page-header-text"><h1>Promotions</h1><p>Manage promotional offers and campaigns.</p></div>
          <button class="btn btn-primary" onclick="openPromoModal()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Add Promotion
          </button>
        </div>
        <div class="card">
          <table class="data-table"><thead><tr>
            <th>Title</th><th>Discount</th><th>Start</th><th>End</th><th>Status</th><th style="width: 120px; text-align: right;">Actions</th>
          </tr></thead><tbody id="promosList"></tbody></table>
        </div>
      </section>

      <!-- Policies Section -->
      <section id="policies" class="section">
        <div class="page-header">
          <div class="page-header-text"><h1>Policies</h1><p>Manage policy documents and guidelines.</p></div>
          <button class="btn btn-primary" onclick="openPolicyModal()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Add Policy
          </button>
        </div>
        <div class="card">
          <table class="data-table"><thead><tr>
            <th style="width: 40px;"></th><th>Title</th><th>Category</th><th>URL</th><th style="width: 120px; text-align: right;">Actions</th>
          </tr></thead><tbody id="policiesList"></tbody></table>
        </div>
      </section>

      <!-- Links Section -->
      <section id="links" class="section">
        <div class="page-header">
          <div class="page-header-text"><h1>Resources & Links</h1><p>Manage quick links and resources for directors.</p></div>
          <button class="btn btn-primary" onclick="openLinkModal()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Add Resource
          </button>
        </div>
        <div class="card">
          <table class="data-table"><thead><tr>
            <th style="width: 40px;"></th><th>Title</th><th>Category</th><th>URL</th><th style="width: 120px; text-align: right;">Actions</th>
          </tr></thead><tbody id="linksList"></tbody></table>
        </div>
      </section>

      <!-- Script Section -->
      <section id="script" class="section">
        <div class="page-header">
          <div class="page-header-text"><h1>Enrollment Script</h1><p>Edit the enrollment script displayed to directors.</p></div>
          <button class="btn btn-primary" onclick="saveScript()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
            Save Script
          </button>
        </div>
        <div class="card">
          <div class="editor-toolbar">
            <button class="editor-btn" onclick="formatText('h2')" title="Heading 2">H2</button>
            <button class="editor-btn" onclick="formatText('h3')" title="Heading 3">H3</button>
            <button class="editor-btn" onclick="formatText('p')" title="Paragraph">P</button>
            <button class="editor-btn" onclick="document.execCommand('bold')" title="Bold"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path></svg></button>
            <button class="editor-btn" onclick="document.execCommand('italic')" title="Italic"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="4" x2="10" y2="4"></line><line x1="14" y1="20" x2="5" y2="20"></line><line x1="15" y1="4" x2="9" y2="20"></line></svg></button>
            <button class="editor-btn" onclick="document.execCommand('insertUnorderedList')" title="Bullet List">•</button>
            <button class="editor-btn" onclick="document.execCommand('insertOrderedList')" title="Numbered List">1.</button>
            <button class="editor-btn" onclick="formatText('blockquote')" title="Quote">"</button>
          </div>
          <div class="editor-content" id="scriptEditor" contenteditable="true"></div>
        </div>
      </section>

      <!-- Team Section -->
      <section id="team" class="section">
        <div class="page-header">
          <div class="page-header-text"><h1>Team Members</h1><p>Manage enrollment team members.</p></div>
          <button class="btn btn-primary" onclick="openTeamModal()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Add Team Member
          </button>
        </div>
        <div class="card">
          <table class="data-table"><thead><tr>
            <th style="width: 40px;"></th><th>Member</th><th>Role</th><th>Email</th><th>Ext.</th><th>Zone</th><th style="width: 120px; text-align: right;">Actions</th>
          </tr></thead><tbody id="teamList"></tbody></table>
        </div>
      </section>

      <!-- Zones Section -->
      <section id="zones" class="section">
        <div class="page-header">
          <div class="page-header-text"><h1>Zones</h1><p>Manage geographic zones for team organization.</p></div>
          <button class="btn btn-primary" onclick="openZoneModal()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Add Zone
          </button>
        </div>
        <div class="card">
          <table class="data-table"><thead><tr>
            <th style="width: 40px;"></th><th>Zone Name</th><th>Color</th><th>Members</th><th style="width: 120px; text-align: right;">Actions</th>
          </tr></thead><tbody id="zonesList"></tbody></table>
        </div>
      </section>
    </main>
  </div>

  <!-- Modals (Announcement, Promo, Policy, Link, Team, Zone, Delete) -->
  <div class="modal-overlay" id="announcementModal" onclick="closeModal('announcementModal', event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header"><h3 id="announcementModalTitle">Add Announcement</h3><button class="modal-close" onclick="closeModal('announcementModal')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
      <div class="modal-body">
        <input type="hidden" id="announcementId">
        <div class="form-group"><label>Title *</label><input type="text" class="form-input" id="announcementTitle" placeholder="Enter title"></div>
        <div class="form-group"><label>Content</label><textarea class="form-textarea" id="announcementContent" placeholder="Enter details"></textarea></div>
        <div class="form-row">
          <div class="form-group"><label>Date</label><input type="date" class="form-input" id="announcementDate"></div>
          <div class="form-group"><label>Status</label><div class="form-switch" style="margin-top: 8px;"><label class="switch"><input type="checkbox" id="announcementActive" checked><span class="switch-slider"></span></label><span>Active</span></div></div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('announcementModal')">Cancel</button><button class="btn btn-primary" onclick="saveAnnouncement()">Save</button></div>
    </div>
  </div>

  <div class="modal-overlay" id="promoModal" onclick="closeModal('promoModal', event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header"><h3 id="promoModalTitle">Add Promotion</h3><button class="modal-close" onclick="closeModal('promoModal')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
      <div class="modal-body">
        <input type="hidden" id="promoId">
        <div class="form-group"><label>Title *</label><input type="text" class="form-input" id="promoTitle" placeholder="e.g., Spring Enrollment Special"></div>
        <div class="form-group"><label>Discount/Offer</label><input type="text" class="form-input" id="promoDiscount" placeholder="e.g., 50% Off Registration"></div>
        <div class="form-group"><label>Description</label><textarea class="form-textarea" id="promoDescription" placeholder="Brief description"></textarea></div>
        <div class="form-group"><label>Additional Details</label><textarea class="form-textarea" id="promoDetails" placeholder="Terms, conditions, etc."></textarea></div>
        <div class="form-row">
          <div class="form-group"><label>Start Date *</label><input type="date" class="form-input" id="promoStartDate"></div>
          <div class="form-group"><label>End Date</label><input type="date" class="form-input" id="promoEndDate"><p class="hint">Leave blank for ongoing</p></div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('promoModal')">Cancel</button><button class="btn btn-primary" onclick="savePromo()">Save</button></div>
    </div>
  </div>

  <div class="modal-overlay" id="policyModal" onclick="closeModal('policyModal', event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header"><h3 id="policyModalTitle">Add Policy</h3><button class="modal-close" onclick="closeModal('policyModal')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
      <div class="modal-body">
        <input type="hidden" id="policyId">
        <div class="form-group"><label>Title *</label><input type="text" class="form-input" id="policyTitle" placeholder="Policy name"></div>
        <div class="form-group"><label>Category *</label><input type="text" class="form-input" id="policyCategory" placeholder="e.g., Enrollment, Safety"></div>
        <div class="form-group"><label>Document URL *</label><input type="url" class="form-input" id="policyUrl" placeholder="https://..."></div>
        <div class="form-group"><label>Description</label><textarea class="form-textarea" id="policyDescription" placeholder="Brief description (optional)"></textarea></div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('policyModal')">Cancel</button><button class="btn btn-primary" onclick="savePolicy()">Save</button></div>
    </div>
  </div>

  <div class="modal-overlay" id="linkModal" onclick="closeModal('linkModal', event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header"><h3 id="linkModalTitle">Add Resource</h3><button class="modal-close" onclick="closeModal('linkModal')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
      <div class="modal-body">
        <input type="hidden" id="linkId">
        <div class="form-group"><label>Title *</label><input type="text" class="form-input" id="linkTitle" placeholder="Resource name"></div>
        <div class="form-group"><label>Category</label><input type="text" class="form-input" id="linkCategory" placeholder="e.g., Forms, Tools"></div>
        <div class="form-group"><label>URL *</label><input type="url" class="form-input" id="linkUrl" placeholder="https://..."></div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('linkModal')">Cancel</button><button class="btn btn-primary" onclick="saveLink()">Save</button></div>
    </div>
  </div>

  <div class="modal-overlay" id="teamModal" onclick="closeModal('teamModal', event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header"><h3 id="teamModalTitle">Add Team Member</h3><button class="modal-close" onclick="closeModal('teamModal')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
      <div class="modal-body">
        <input type="hidden" id="teamMemberId">
        <div class="form-group">
          <label>Avatar</label>
          <div class="avatar-upload">
            <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face" class="avatar-preview" id="teamAvatarPreview">
            <div class="avatar-actions">
              <input type="file" id="teamAvatarFile" accept="image/*" style="display: none;" onchange="previewAvatar(this)">
              <button class="btn btn-sm btn-secondary" onclick="document.getElementById('teamAvatarFile').click()">Upload Image</button>
              <input type="text" class="form-input" id="teamAvatarUrl" placeholder="Or paste image URL" style="font-size: 12px; padding: 6px 10px;">
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Name *</label><input type="text" class="form-input" id="teamName" placeholder="Full name"></div>
          <div class="form-group"><label>Role</label><input type="text" class="form-input" id="teamRole" placeholder="e.g., Enrollment Specialist"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Email *</label><input type="email" class="form-input" id="teamEmail" placeholder="email@example.com"></div>
          <div class="form-group"><label>Phone Extension</label><input type="text" class="form-input" id="teamExtension" placeholder="e.g., 1234"></div>
        </div>
        <div class="form-group"><label>Zone</label><select class="form-select" id="teamZone"><option value="">Select zone...</option></select></div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('teamModal')">Cancel</button><button class="btn btn-primary" onclick="saveTeamMember()">Save</button></div>
    </div>
  </div>

  <div class="modal-overlay" id="zoneModal" onclick="closeModal('zoneModal', event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header"><h3 id="zoneModalTitle">Add Zone</h3><button class="modal-close" onclick="closeModal('zoneModal')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
      <div class="modal-body">
        <input type="hidden" id="zoneId">
        <div class="form-group"><label>Zone Name *</label><input type="text" class="form-input" id="zoneName" placeholder="e.g., Northeast"></div>
        <div class="form-group"><label>Color</label><input type="color" class="form-input" id="zoneColor" value="#F97B5F" style="height: 44px; padding: 4px;"></div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('zoneModal')">Cancel</button><button class="btn btn-primary" onclick="saveZone()">Save</button></div>
    </div>
  </div>

  <div class="modal-overlay" id="deleteModal" onclick="closeModal('deleteModal', event)">
    <div class="modal" style="max-width: 400px;" onclick="event.stopPropagation()">
      <div class="modal-header"><h3>Confirm Delete</h3><button class="modal-close" onclick="closeModal('deleteModal')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
      <div class="modal-body"><p>Are you sure you want to delete this item? This action cannot be undone.</p></div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancel</button><button class="btn btn-danger" onclick="confirmDelete()">Delete</button></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const SUPABASE_URL = 'https://kvyvjwepfrqqkvyyutdw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2eXZqd2VwZnJxcWt2eXl1dGR3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyMjgyOTgsImV4cCI6MjA4MjgwNDI5OH0.ZayLxzQCEFENvQ9FwpLm4x2le2Y9kJvSslX8DVRzAh8';

    let supabaseClient = null, isConnected = false, deleteCallback = null;
    let announcements = [], promos = [], policies = [], links = [], team = [], zones = [], scriptContent = '';

    async function init() {
      try {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const { error } = await supabaseClient.from('announcements').select('count');
        if (!error) { isConnected = true; updateConnectionStatus(true); await loadAllData(); return; }
      } catch (e) { console.error(e); }
      updateConnectionStatus(false);
      loadFromLocalStorage();
    }

    function updateConnectionStatus(connected) {
      document.getElementById('connectionDot').className = 'connection-dot ' + (connected ? 'connected' : 'disconnected');
      document.getElementById('connectionText').textContent = connected ? 'Connected to Supabase' : 'Demo Mode (localStorage)';
    }

    async function loadAllData() {
      try {
        const [r1, r2, r3, r4, r5, r6, r7] = await Promise.all([
          supabaseClient.from('announcements').select('*').order('created_at', { ascending: false }),
          supabaseClient.from('promos').select('*').order('start_date', { ascending: false }),
          supabaseClient.from('policies').select('*').order('sort_order'),
          supabaseClient.from('links').select('*').order('sort_order'),
          supabaseClient.from('team_members').select('*').order('sort_order'),
          supabaseClient.from('zones').select('*').order('sort_order'),
          supabaseClient.from('settings').select('value').eq('key', 'enrollment_script').single()
        ]);
        announcements = r1.data || []; promos = r2.data || []; policies = r3.data || [];
        links = r4.data || []; team = r5.data || []; zones = r6.data || [];
        scriptContent = r7.data?.value || getDefaultScript();
        renderAll();
      } catch (e) { console.error(e); loadFromLocalStorage(); }
    }

    function loadFromLocalStorage() {
      announcements = JSON.parse(localStorage.getItem('admin_announcements') || '[]');
      promos = JSON.parse(localStorage.getItem('admin_promos') || '[]');
      policies = JSON.parse(localStorage.getItem('admin_policies') || '[]');
      links = JSON.parse(localStorage.getItem('admin_links') || '[]');
      team = JSON.parse(localStorage.getItem('admin_team') || '[]');
      zones = JSON.parse(localStorage.getItem('admin_zones') || '[]');
      scriptContent = localStorage.getItem('admin_script') || getDefaultScript();
      renderAll();
    }

    function saveToLocalStorage() {
      localStorage.setItem('admin_announcements', JSON.stringify(announcements));
      localStorage.setItem('admin_promos', JSON.stringify(promos));
      localStorage.setItem('admin_policies', JSON.stringify(policies));
      localStorage.setItem('admin_links', JSON.stringify(links));
      localStorage.setItem('admin_team', JSON.stringify(team));
      localStorage.setItem('admin_zones', JSON.stringify(zones));
      localStorage.setItem('admin_script', scriptContent);
    }

    function getDefaultScript() {
      return `<h2>Welcome Script</h2><p>Hello! My name is [Your Name], and I'm excited to show you around today.</p><h3>Opening Questions</h3><ul><li>What brings you to us today?</li><li>Tell me about your child</li><li>What's most important to you?</li></ul><h3>Tour Flow</h3><ol><li>Classroom your child would be in</li><li>Outdoor play areas</li><li>Safety features</li><li>Meal preparation area</li></ol><blockquote>"What makes us different is our focus on [unique value]. Parents tell us they chose us because..."</blockquote><h3>Closing</h3><p>Based on everything we've discussed, I think your child would thrive here. Would you like to secure your spot today?</p>`;
    }

    function renderAll() {
      renderAnnouncements(); renderPromos(); renderPolicies(); renderLinks(); renderTeam(); renderZones();
      document.getElementById('scriptEditor').innerHTML = scriptContent;
      initSortables();
    }

    function renderAnnouncements() {
      const tbody = document.getElementById('announcementsList');
      if (!announcements.length) { tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><p>No announcements yet</p><button class="btn btn-primary btn-sm" onclick="openAnnouncementModal()">Add your first</button></div></td></tr>'; return; }
      tbody.innerHTML = announcements.map(a => `<tr data-id="${a.id}"><td><span class="drag-handle">⋮⋮</span></td><td><strong>${esc(a.title)}</strong></td><td>${formatDate(a.date || a.created_at)}</td><td><span class="status-badge ${a.active ? 'active' : 'inactive'}">${a.active ? 'Active' : 'Inactive'}</span></td><td class="actions"><button class="btn-icon" onclick="editAnnouncement('${a.id}')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg></button><button class="btn-icon danger" onclick="deleteItem('announcement', '${a.id}')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button></td></tr>`).join('');
    }

    function renderPromos() {
      const tbody = document.getElementById('promosList');
      if (!promos.length) { tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><p>No promotions yet</p><button class="btn btn-primary btn-sm" onclick="openPromoModal()">Add your first</button></div></td></tr>'; return; }
      tbody.innerHTML = promos.map(p => { const s = getPromoStatus(p); return `<tr data-id="${p.id}"><td><strong>${esc(p.title)}</strong></td><td>${esc(p.discount || '-')}</td><td>${formatDate(p.start_date)}</td><td>${p.end_date ? formatDate(p.end_date) : 'Ongoing'}</td><td><span class="status-badge ${s}">${s.charAt(0).toUpperCase() + s.slice(1)}</span></td><td class="actions"><button class="btn-icon" onclick="editPromo('${p.id}')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg></button><button class="btn-icon danger" onclick="deleteItem('promo', '${p.id}')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button></td></tr>`; }).join('');
    }

    function renderPolicies() {
      const tbody = document.getElementById('policiesList');
      if (!policies.length) { tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><p>No policies yet</p><button class="btn btn-primary btn-sm" onclick="openPolicyModal()">Add your first</button></div></td></tr>'; return; }
      tbody.innerHTML = policies.map(p => `<tr data-id="${p.id}"><td><span class="drag-handle">⋮⋮</span></td><td><strong>${esc(p.title)}</strong></td><td><span class="zone-badge">${esc(p.category || 'General')}</span></td><td><a href="${esc(p.url)}" target="_blank" style="color: var(--color-coral);">${truncate(p.url, 30)}</a></td><td class="actions"><button class="btn-icon" onclick="editPolicy('${p.id}')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg></button><button class="btn-icon danger" onclick="deleteItem('policy', '${p.id}')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button></td></tr>`).join('');
    }

    function renderLinks() {
      const tbody = document.getElementById('linksList');
      if (!links.length) { tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><p>No resources yet</p><button class="btn btn-primary btn-sm" onclick="openLinkModal()">Add your first</button></div></td></tr>'; return; }
      tbody.innerHTML = links.map(l => `<tr data-id="${l.id}"><td><span class="drag-handle">⋮⋮</span></td><td><strong>${esc(l.title)}</strong></td><td><span class="zone-badge">${esc(l.category || 'Resource')}</span></td><td><a href="${esc(l.url)}" target="_blank" style="color: var(--color-coral);">${truncate(l.url, 30)}</a></td><td class="actions"><button class="btn-icon" onclick="editLink('${l.id}')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg></button><button class="btn-icon danger" onclick="deleteItem('link', '${l.id}')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button></td></tr>`).join('');
    }

    function renderTeam() {
      const tbody = document.getElementById('teamList');
      if (!team.length) { tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><p>No team members yet</p><button class="btn btn-primary btn-sm" onclick="openTeamModal()">Add your first</button></div></td></tr>'; return; }
      tbody.innerHTML = team.map(t => `<tr data-id="${t.id}"><td><span class="drag-handle">⋮⋮</span></td><td><div style="display: flex; align-items: center; gap: 12px;"><img src="${esc(t.avatar_url || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face')}" class="avatar avatar-sm"><strong>${esc(t.name)}</strong></div></td><td>${esc(t.role || '-')}</td><td>${esc(t.email || '-')}</td><td>${esc(t.extension || '-')}</td><td><span class="zone-badge">${esc(t.zone || 'General')}</span></td><td class="actions"><button class="btn-icon" onclick="editTeamMember('${t.id}')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg></button><button class="btn-icon danger" onclick="deleteItem('team', '${t.id}')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button></td></tr>`).join('');
      updateZoneDropdowns();
    }

    function renderZones() {
      const tbody = document.getElementById('zonesList');
      if (!zones.length) { tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><p>No zones yet</p><button class="btn btn-primary btn-sm" onclick="openZoneModal()">Add your first</button></div></td></tr>'; return; }
      tbody.innerHTML = zones.map(z => { const mc = team.filter(t => t.zone === z.name).length; return `<tr data-id="${z.id}"><td><span class="drag-handle">⋮⋮</span></td><td><strong>${esc(z.name)}</strong></td><td><div style="width: 24px; height: 24px; border-radius: 6px; background: ${esc(z.color || '#F97B5F')};"></div></td><td>${mc} member${mc !== 1 ? 's' : ''}</td><td class="actions"><button class="btn-icon" onclick="editZone('${z.id}')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg></button><button class="btn-icon danger" onclick="deleteItem('zone', '${z.id}')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button></td></tr>`; }).join('');
    }

    function updateZoneDropdowns() { document.getElementById('teamZone').innerHTML = '<option value="">Select zone...</option>' + zones.map(z => `<option value="${esc(z.name)}">${esc(z.name)}</option>`).join(''); }

    function initSortables() {
      ['announcementsList', 'policiesList', 'linksList', 'teamList', 'zonesList'].forEach(id => {
        const el = document.getElementById(id);
        if (el && el.querySelector('.drag-handle')) new Sortable(el, { handle: '.drag-handle', animation: 150, onEnd: (evt) => handleReorder(id, evt) });
      });
    }

    async function handleReorder(listId, evt) {
      const map = { announcementsList: ['announcements', announcements], policiesList: ['policies', policies], linksList: ['links', links], teamList: ['team_members', team], zonesList: ['zones', zones] };
      const [table, data] = map[listId];
      const item = data.splice(evt.oldIndex, 1)[0];
      data.splice(evt.newIndex, 0, item);
      data.forEach((d, i) => d.sort_order = i);
      if (isConnected) { for (const d of data) await supabaseClient.from(table).update({ sort_order: d.sort_order }).eq('id', d.id); }
      saveToLocalStorage();
      showToast('Order updated');
    }

    // CRUD Functions
    function openAnnouncementModal(data = null) { document.getElementById('announcementModalTitle').textContent = data ? 'Edit Announcement' : 'Add Announcement'; document.getElementById('announcementId').value = data?.id || ''; document.getElementById('announcementTitle').value = data?.title || ''; document.getElementById('announcementContent').value = data?.content || ''; document.getElementById('announcementDate').value = data?.date || new Date().toISOString().split('T')[0]; document.getElementById('announcementActive').checked = data?.active !== false; document.getElementById('announcementModal').classList.add('active'); }
    function editAnnouncement(id) { const a = announcements.find(x => x.id === id); if (a) openAnnouncementModal(a); }
    async function saveAnnouncement() { const id = document.getElementById('announcementId').value; const data = { title: document.getElementById('announcementTitle').value.trim(), content: document.getElementById('announcementContent').value.trim(), date: document.getElementById('announcementDate').value, active: document.getElementById('announcementActive').checked }; if (!data.title) { showToast('Title is required', 'error'); return; } if (isConnected) { if (id) await supabaseClient.from('announcements').update(data).eq('id', id); else { data.sort_order = announcements.length; await supabaseClient.from('announcements').insert(data); } await loadAllData(); } else { if (id) { const idx = announcements.findIndex(a => a.id === id); if (idx >= 0) announcements[idx] = { ...announcements[idx], ...data }; } else { data.id = Date.now().toString(); data.created_at = new Date().toISOString(); data.sort_order = announcements.length; announcements.unshift(data); } saveToLocalStorage(); renderAnnouncements(); } closeModal('announcementModal'); showToast(id ? 'Announcement updated' : 'Announcement added', 'success'); }

    function openPromoModal(data = null) { document.getElementById('promoModalTitle').textContent = data ? 'Edit Promotion' : 'Add Promotion'; document.getElementById('promoId').value = data?.id || ''; document.getElementById('promoTitle').value = data?.title || ''; document.getElementById('promoDiscount').value = data?.discount || ''; document.getElementById('promoDescription').value = data?.description || ''; document.getElementById('promoDetails').value = data?.details || ''; document.getElementById('promoStartDate').value = data?.start_date || ''; document.getElementById('promoEndDate').value = data?.end_date || ''; document.getElementById('promoModal').classList.add('active'); }
    function editPromo(id) { const p = promos.find(x => x.id === id); if (p) openPromoModal(p); }
    async function savePromo() { const id = document.getElementById('promoId').value; const data = { title: document.getElementById('promoTitle').value.trim(), discount: document.getElementById('promoDiscount').value.trim(), description: document.getElementById('promoDescription').value.trim(), details: document.getElementById('promoDetails').value.trim(), start_date: document.getElementById('promoStartDate').value, end_date: document.getElementById('promoEndDate').value || null }; if (!data.title || !data.start_date) { showToast('Title and start date are required', 'error'); return; } if (isConnected) { if (id) await supabaseClient.from('promos').update(data).eq('id', id); else await supabaseClient.from('promos').insert(data); await loadAllData(); } else { if (id) { const idx = promos.findIndex(p => p.id === id); if (idx >= 0) promos[idx] = { ...promos[idx], ...data }; } else { data.id = Date.now().toString(); promos.unshift(data); } saveToLocalStorage(); renderPromos(); } closeModal('promoModal'); showToast(id ? 'Promotion updated' : 'Promotion added', 'success'); }

    function openPolicyModal(data = null) { document.getElementById('policyModalTitle').textContent = data ? 'Edit Policy' : 'Add Policy'; document.getElementById('policyId').value = data?.id || ''; document.getElementById('policyTitle').value = data?.title || ''; document.getElementById('policyCategory').value = data?.category || ''; document.getElementById('policyUrl').value = data?.url || ''; document.getElementById('policyDescription').value = data?.description || ''; document.getElementById('policyModal').classList.add('active'); }
    function editPolicy(id) { const p = policies.find(x => x.id === id); if (p) openPolicyModal(p); }
    async function savePolicy() { const id = document.getElementById('policyId').value; const data = { title: document.getElementById('policyTitle').value.trim(), category: document.getElementById('policyCategory').value.trim(), url: document.getElementById('policyUrl').value.trim(), description: document.getElementById('policyDescription').value.trim() }; if (!data.title || !data.url) { showToast('Title and URL are required', 'error'); return; } if (isConnected) { if (id) await supabaseClient.from('policies').update(data).eq('id', id); else { data.sort_order = policies.length; await supabaseClient.from('policies').insert(data); } await loadAllData(); } else { if (id) { const idx = policies.findIndex(p => p.id === id); if (idx >= 0) policies[idx] = { ...policies[idx], ...data }; } else { data.id = Date.now().toString(); data.sort_order = policies.length; policies.push(data); } saveToLocalStorage(); renderPolicies(); } closeModal('policyModal'); showToast(id ? 'Policy updated' : 'Policy added', 'success'); }

    function openLinkModal(data = null) { document.getElementById('linkModalTitle').textContent = data ? 'Edit Resource' : 'Add Resource'; document.getElementById('linkId').value = data?.id || ''; document.getElementById('linkTitle').value = data?.title || ''; document.getElementById('linkCategory').value = data?.category || ''; document.getElementById('linkUrl').value = data?.url || ''; document.getElementById('linkModal').classList.add('active'); }
    function editLink(id) { const l = links.find(x => x.id === id); if (l) openLinkModal(l); }
    async function saveLink() { const id = document.getElementById('linkId').value; const data = { title: document.getElementById('linkTitle').value.trim(), category: document.getElementById('linkCategory').value.trim(), url: document.getElementById('linkUrl').value.trim() }; if (!data.title || !data.url) { showToast('Title and URL are required', 'error'); return; } if (isConnected) { if (id) await supabaseClient.from('links').update(data).eq('id', id); else { data.sort_order = links.length; await supabaseClient.from('links').insert(data); } await loadAllData(); } else { if (id) { const idx = links.findIndex(l => l.id === id); if (idx >= 0) links[idx] = { ...links[idx], ...data }; } else { data.id = Date.now().toString(); data.sort_order = links.length; links.push(data); } saveToLocalStorage(); renderLinks(); } closeModal('linkModal'); showToast(id ? 'Resource updated' : 'Resource added', 'success'); }

    function openTeamModal(data = null) { document.getElementById('teamModalTitle').textContent = data ? 'Edit Team Member' : 'Add Team Member'; document.getElementById('teamMemberId').value = data?.id || ''; document.getElementById('teamName').value = data?.name || ''; document.getElementById('teamRole').value = data?.role || ''; document.getElementById('teamEmail').value = data?.email || ''; document.getElementById('teamExtension').value = data?.extension || ''; document.getElementById('teamZone').value = data?.zone || ''; document.getElementById('teamAvatarUrl').value = data?.avatar_url || ''; document.getElementById('teamAvatarPreview').src = data?.avatar_url || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face'; document.getElementById('teamModal').classList.add('active'); }
    function editTeamMember(id) { const t = team.find(x => x.id === id); if (t) openTeamModal(t); }
    function previewAvatar(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = (e) => { document.getElementById('teamAvatarPreview').src = e.target.result; document.getElementById('teamAvatarUrl').value = e.target.result; }; reader.readAsDataURL(input.files[0]); } }
    async function saveTeamMember() { const id = document.getElementById('teamMemberId').value; const data = { name: document.getElementById('teamName').value.trim(), role: document.getElementById('teamRole').value.trim(), email: document.getElementById('teamEmail').value.trim(), extension: document.getElementById('teamExtension').value.trim(), zone: document.getElementById('teamZone').value, avatar_url: document.getElementById('teamAvatarUrl').value.trim() }; if (!data.name || !data.email) { showToast('Name and email are required', 'error'); return; } if (isConnected) { if (id) await supabaseClient.from('team_members').update(data).eq('id', id); else { data.sort_order = team.length; await supabaseClient.from('team_members').insert(data); } await loadAllData(); } else { if (id) { const idx = team.findIndex(t => t.id === id); if (idx >= 0) team[idx] = { ...team[idx], ...data }; } else { data.id = Date.now().toString(); data.sort_order = team.length; team.push(data); } saveToLocalStorage(); renderTeam(); } closeModal('teamModal'); showToast(id ? 'Team member updated' : 'Team member added', 'success'); }

    function openZoneModal(data = null) { document.getElementById('zoneModalTitle').textContent = data ? 'Edit Zone' : 'Add Zone'; document.getElementById('zoneId').value = data?.id || ''; document.getElementById('zoneName').value = data?.name || ''; document.getElementById('zoneColor').value = data?.color || '#F97B5F'; document.getElementById('zoneModal').classList.add('active'); }
    function editZone(id) { const z = zones.find(x => x.id === id); if (z) openZoneModal(z); }
    async function saveZone() { const id = document.getElementById('zoneId').value; const data = { name: document.getElementById('zoneName').value.trim(), color: document.getElementById('zoneColor').value }; if (!data.name) { showToast('Zone name is required', 'error'); return; } if (isConnected) { if (id) await supabaseClient.from('zones').update(data).eq('id', id); else { data.sort_order = zones.length; await supabaseClient.from('zones').insert(data); } await loadAllData(); } else { if (id) { const idx = zones.findIndex(z => z.id === id); if (idx >= 0) zones[idx] = { ...zones[idx], ...data }; } else { data.id = Date.now().toString(); data.sort_order = zones.length; zones.push(data); } saveToLocalStorage(); renderZones(); updateZoneDropdowns(); } closeModal('zoneModal'); showToast(id ? 'Zone updated' : 'Zone added', 'success'); }

    async function saveScript() { scriptContent = document.getElementById('scriptEditor').innerHTML; if (isConnected) { const { data } = await supabaseClient.from('settings').select('id').eq('key', 'enrollment_script').single(); if (data) await supabaseClient.from('settings').update({ value: scriptContent }).eq('key', 'enrollment_script'); else await supabaseClient.from('settings').insert({ key: 'enrollment_script', value: scriptContent }); } saveToLocalStorage(); showToast('Script saved', 'success'); }

    function formatText(tag) { document.execCommand('formatBlock', false, tag); }

    function deleteItem(type, id) { deleteCallback = async () => { const map = { announcement: ['announcements', announcements], promo: ['promos', promos], policy: ['policies', policies], link: ['links', links], team: ['team_members', team], zone: ['zones', zones] }; const [table, arr] = map[type]; if (isConnected) { await supabaseClient.from(table).delete().eq('id', id); await loadAllData(); } else { const idx = arr.findIndex(x => x.id === id); if (idx >= 0) arr.splice(idx, 1); saveToLocalStorage(); renderAll(); } showToast('Item deleted', 'success'); }; document.getElementById('deleteModal').classList.add('active'); }
    function confirmDelete() { if (deleteCallback) deleteCallback(); closeModal('deleteModal'); deleteCallback = null; }

    function getPromoStatus(p) { const now = new Date(), s = new Date(p.start_date), e = p.end_date ? new Date(p.end_date) : null; if (s > now) return 'upcoming'; if (e && e < now) return 'ended'; return 'active'; }
    function formatDate(d) { if (!d) return '-'; return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); }
    function truncate(s, l) { if (!s) return ''; return s.length > l ? s.substring(0, l) + '...' : s; }
    function esc(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

    function closeModal(id, e) { if (e && e.target !== e.currentTarget) return; document.getElementById(id).classList.remove('active'); }
    function switchSection(id) { document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); event.currentTarget.classList.add('active'); document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); closeSidebar(); }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebarOverlay').classList.toggle('open'); }
    function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('open'); }
    function showToast(msg, type = '') { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast show ' + type; setTimeout(() => t.classList.remove('show'), 3000); }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
