<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Map - Enrollment Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <style>
        :root {
            --primary: #FA8072;
            --primary-light: #FFB4A2;
            --primary-dark: #E96E5D;
            --secondary: #FF6B9D;
            --accent: #FFA07A;
            --text-primary: #2D3748;
            --text-secondary: #718096;
            --text-light: #A0AEC0;
            --white: #FFFFFF;
            --gray-50: #F8F9FA;
            --gray-100: #F1F3F5;
            --gray-200: #E9ECEF;
            --gray-300: #DEE2E6;
            --shadow-sm: 0 2px 4px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px 0 rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 30px 0 rgba(0, 0, 0, 0.12);
            --sidebar-width: 260px;
            --map-sidebar-width: 320px;
            --sidebar-collapsed: 70px;
            --transition-speed: 0.3s;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #F8F9FA; min-height: 100vh; color: var(--text-primary); overflow-x: hidden; }
        .sidebar { position: fixed; top: 0; left: 0; width: var(--sidebar-width); height: 100vh; background: var(--white); border-right: 1px solid var(--gray-200); box-shadow: var(--shadow-sm); transition: transform var(--transition-speed) ease, width var(--transition-speed) ease; z-index: 1000; display: flex; flex-direction: column; }
        .sidebar.collapsed { width: var(--sidebar-collapsed); }
        .sidebar-header { padding: 1.5rem 1.25rem; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--gray-200); }
        .logo-section { display: flex; align-items: center; gap: 0.75rem; transition: opacity var(--transition-speed) ease; }
        .sidebar.collapsed .logo-section { opacity: 0; pointer-events: none; }
        .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1rem; color: var(--white); font-weight: 700; }
        .logo-text { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); white-space: nowrap; }
        .toggle-btn { width: 32px; height: 32px; border: 1px solid var(--gray-200); background: var(--white); color: var(--text-secondary); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .toggle-btn:hover { background: var(--gray-50); }
        .sidebar.collapsed .toggle-icon { transform: rotate(180deg); }
        .toggle-icon { transition: transform var(--transition-speed) ease; }
        .sidebar-nav { flex: 1; overflow-y: auto; padding: 1rem 0; }
        .nav-item { display: flex; align-items: center; gap: 0.875rem; padding: 0.875rem 1.5rem; margin: 0.25rem 0.75rem; color: var(--text-secondary); text-decoration: none; border-radius: 10px; transition: all 0.2s ease; cursor: pointer; border: none; background: transparent; width: calc(100% - 1.5rem); font-size: 0.9375rem; font-weight: 500; }
        .nav-item:hover { background: var(--gray-100); color: var(--text-primary); }
        .nav-item.active { background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: var(--white); box-shadow: 0 4px 12px rgba(250, 128, 114, 0.3); }
        .nav-icon { font-size: 1.25rem; width: 20px; }
        .nav-text { white-space: nowrap; transition: opacity var(--transition-speed) ease; }
        .sidebar.collapsed .nav-text { opacity: 0; pointer-events: none; }
        .sidebar.collapsed .nav-item { justify-content: center; padding: 0.875rem; }
        .sidebar-footer { padding: 0.5rem 0 1rem 0; border-top: 1px solid var(--gray-200); }
        .logout-btn { color: var(--secondary) !important; }
        .logout-btn:hover { background: rgba(255, 107, 157, 0.1) !important; }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999; opacity: 0; pointer-events: none; transition: opacity var(--transition-speed) ease; }
        .sidebar-overlay.active { opacity: 1; pointer-events: all; }
        .main-content { margin-left: var(--sidebar-width); height: 100vh; display: flex; transition: margin-left var(--transition-speed) ease; }
        .sidebar.collapsed ~ .main-content { margin-left: var(--sidebar-collapsed); }
        .map-sidebar { width: var(--map-sidebar-width); height: 100%; background: var(--white); border-right: 1px solid var(--gray-200); display: flex; flex-direction: column; }
        .map-sidebar-header { padding: 1.25rem; border-bottom: 1px solid var(--gray-200); background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: white; }
        .map-sidebar-header h1 { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.5rem; }
        .map-sidebar-header p { font-size: 0.8125rem; opacity: 0.9; }
        .filters-section { padding: 1rem; border-bottom: 1px solid var(--gray-200); background: var(--gray-50); }
        .filter-group { margin-bottom: 0.75rem; }
        .filter-group:last-child { margin-bottom: 0; }
        .filter-group label { display: block; font-size: 0.6875rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.375rem; }
        .form-select, .form-input { width: 100%; padding: 0.5rem 0.75rem; border: 1.5px solid var(--gray-200); border-radius: 8px; font-size: 0.8125rem; color: var(--text-primary); background: var(--white); }
        .form-select:focus, .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(250, 128, 114, 0.1); }
        .form-select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23718096' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; padding-right: 2rem; }
        .filter-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        .clear-filters-btn { width: 100%; padding: 0.5rem; border: 1.5px solid var(--gray-300); background: var(--white); border-radius: 8px; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.375rem; margin-top: 0.75rem; }
        .clear-filters-btn:hover { border-color: var(--primary); color: var(--primary); background: rgba(250, 128, 114, 0.05); }
        .studio-list-header { padding: 0.75rem 1rem; background: var(--white); border-bottom: 1px solid var(--gray-200); display: flex; align-items: center; justify-content: space-between; }
        .studio-list-header h3 { font-size: 0.8125rem; font-weight: 600; }
        .studio-count { background: var(--primary); color: white; padding: 0.25rem 0.625rem; border-radius: 12px; font-size: 0.6875rem; font-weight: 700; }
        .studio-list { flex: 1; overflow-y: auto; padding: 0.5rem; }
        .studio-list-item { padding: 0.75rem; border-radius: 10px; cursor: pointer; border: 1.5px solid transparent; margin-bottom: 0.5rem; }
        .studio-list-item:hover { background: var(--gray-50); border-color: var(--gray-200); }
        .studio-list-item.active { background: rgba(250, 128, 114, 0.1); border-color: var(--primary); }
        .studio-list-item-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.375rem; }
        .studio-list-item-dot { width: 10px; height: 10px; border-radius: 50%; }
        .studio-list-item-name { font-size: 0.875rem; font-weight: 600; color: var(--text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .studio-list-item-location { font-size: 0.75rem; color: var(--text-secondary); margin-left: 1.125rem; }
        .studio-list-item-price { font-size: 0.6875rem; color: var(--text-light); margin-left: 1.125rem; margin-top: 0.25rem; }
        .studio-list-empty { text-align: center; padding: 2rem 1rem; color: var(--text-secondary); }
        .studio-list-empty i { font-size: 2rem; color: var(--gray-300); margin-bottom: 0.5rem; display: block; }
        .map-container { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; }
        .marker-cluster { background: rgba(250, 128, 114, 0.6); border-radius: 50%; }
        .marker-cluster div { background: var(--primary); color: white; font-weight: 700; font-size: 0.875rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .marker-cluster-small { width: 36px; height: 36px; }
        .marker-cluster-small div { width: 28px; height: 28px; }
        .marker-cluster-medium { width: 44px; height: 44px; }
        .marker-cluster-medium div { width: 36px; height: 36px; }
        .marker-cluster-large { width: 52px; height: 52px; }
        .marker-cluster-large div { width: 44px; height: 44px; }
        .map-controls { position: absolute; top: 1rem; left: 1rem; z-index: 500; display: flex; flex-direction: column; gap: 0.5rem; }
        .map-control-btn { width: 36px; height: 36px; background: var(--white); border: none; border-radius: 8px; box-shadow: var(--shadow-md); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-primary); font-size: 0.875rem; }
        .map-control-btn:hover { background: var(--gray-50); transform: scale(1.05); }
        .map-legend { position: absolute; bottom: 2rem; left: 1rem; background: var(--white); border-radius: 10px; padding: 0.75rem; box-shadow: var(--shadow-md); z-index: 500; max-width: 180px; }
        .legend-title { font-size: 0.6875rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
        .legend-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; margin-bottom: 0.25rem; }
        .legend-color { width: 10px; height: 10px; border-radius: 50%; }
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; min-width: 220px; }
        .popup-header { background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); padding: 0.75rem 1rem; color: white; }
        .popup-title { font-size: 0.9375rem; font-weight: 700; margin-bottom: 0.125rem; }
        .popup-zone { font-size: 0.6875rem; opacity: 0.9; background: rgba(255,255,255,0.2); padding: 0.125rem 0.5rem; border-radius: 10px; }
        .popup-body { padding: 0.75rem 1rem; }
        .popup-info-row { display: flex; align-items: flex-start; gap: 0.5rem; font-size: 0.75rem; margin-bottom: 0.5rem; }
        .popup-info-row:last-child { margin-bottom: 0; }
        .popup-info-row i { color: var(--primary); width: 12px; margin-top: 2px; }
        .popup-actions { padding: 0.625rem 0.75rem; background: var(--gray-50); }
        .popup-btn { width: 100%; padding: 0.5rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; text-decoration: none; text-align: center; border: none; display: block; background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: white; cursor: pointer; }
        .popup-btn:hover { box-shadow: 0 2px 8px rgba(250, 128, 114, 0.4); }
        .popup-btn-secondary { background: var(--white); color: var(--primary); border: 2px solid var(--primary) !important; }
        .popup-btn-secondary:hover { background: rgba(250, 128, 114, 0.1); }
        .leaflet-tooltip { background: var(--text-primary); color: white; border: none; border-radius: 6px; padding: 0.375rem 0.625rem; font-size: 0.75rem; font-weight: 500; }
        .leaflet-tooltip-top:before { border-top-color: var(--text-primary); }
        .map-loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--white); padding: 1.25rem 1.5rem; border-radius: 12px; box-shadow: var(--shadow-lg); z-index: 600; display: flex; align-items: center; gap: 0.75rem; font-size: 0.875rem; color: var(--text-secondary); }
        .map-loading i { color: var(--primary); }
        .map-sidebar-toggle { display: none; position: absolute; top: 1rem; right: 1rem; z-index: 600; width: 40px; height: 40px; background: var(--white); border: none; border-radius: 10px; box-shadow: var(--shadow-md); cursor: pointer; align-items: center; justify-content: center; font-size: 1rem; }
        @media (max-width: 1024px) { .sidebar { transform: translateX(-100%); } .sidebar:not(.collapsed) { transform: translateX(0); } .main-content { margin-left: 0; } }
        @media (max-width: 768px) { .map-sidebar { position: absolute; left: 0; top: 0; z-index: 500; width: 100%; max-width: 320px; transform: translateX(-100%); transition: transform 0.3s ease; } .map-sidebar.open { transform: translateX(0); } .map-sidebar-toggle { display: flex; } }
    </style>
</head>
<body>
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <div class="logo-section"><div class="logo-icon">EH</div><span class="logo-text">Enrollment Hub</span></div>
            <button id="sidebarToggle" class="toggle-btn"><span class="toggle-icon">‹</span></button>
        </div>
        <nav class="sidebar-nav">
            <a href="teamdashboard.html" class="nav-item"><span class="nav-icon"><i class="fas fa-chart-line"></i></span><span class="nav-text">Dashboard</span></a>
            <a href="teamquicklinks.html" class="nav-item"><span class="nav-icon"><i class="fas fa-link"></i></span><span class="nav-text">Quick Links</span></a>
            <a href="teamstudio-directory.html" class="nav-item"><span class="nav-icon"><i class="fas fa-building"></i></span><span class="nav-text">Studio Directory</span></a>
            <a href="teamsnippets.html" class="nav-item"><span class="nav-icon"><i class="fas fa-file-alt"></i></span><span class="nav-text">Snippets</span></a>
            <a href="teamsellingpoints.html" class="nav-item"><span class="nav-icon"><i class="fas fa-star"></i></span><span class="nav-text">Selling Points</span></a>
            <a href="teamprograms.html" class="nav-item"><span class="nav-icon"><i class="fas fa-graduation-cap"></i></span><span class="nav-text">Programs</span></a>
            <a href="teamstudio-map.html" class="nav-item active"><span class="nav-icon"><i class="fas fa-map-marked-alt"></i></span><span class="nav-text">Studio Map</span></a>
            <a href="teamcalendar.html" class="nav-item"><span class="nav-icon"><i class="fas fa-calendar-alt"></i></span><span class="nav-text">Calendar</span></a>
            <a href="teamtraining-hub.html" class="nav-item"><span class="nav-icon"><i class="fas fa-book-open"></i></span><span class="nav-text">Training Hub</span></a>
            <a href="teampolicies.html" class="nav-item"><span class="nav-icon"><i class="fas fa-file-alt"></i></span><span class="nav-text">Policies</span></a>
        </nav>
        <div class="sidebar-footer"><button id="logoutBtn" class="nav-item logout-btn"><span class="nav-icon"><i class="fas fa-sign-out-alt"></i></span><span class="nav-text">Logout</span></button></div>
    </div>
    <div id="sidebarOverlay" class="sidebar-overlay"></div>
    <main class="main-content">
        <div class="map-sidebar" id="mapSidebar">
            <div class="map-sidebar-header"><h1><i class="fas fa-map-marked-alt"></i> Studio Map</h1><p>Browse all studio locations</p></div>
            <div class="filters-section">
                <div class="filter-row">
                    <div class="filter-group" id="zoneFilterGroup"><label>Zone</label><select class="form-select" id="zoneFilter"><option value="">All Zones</option></select></div>
                    <div class="filter-group" id="brandFilterGroup"><label>Brand</label><select class="form-select" id="brandFilter"><option value="">All Brands</option></select></div>
                </div>
                <div class="filter-row">
                    <div class="filter-group"><label>State</label><select class="form-select" id="stateFilter"><option value="">All States</option></select></div>
                    <div class="filter-group"><label>City</label><select class="form-select" id="cityFilter"><option value="">All Cities</option></select></div>
                </div>
                <div class="filter-group"><label>Search</label><input type="text" class="form-input" id="searchInput" placeholder="Search studios..."></div>
                <button class="clear-filters-btn" onclick="clearAllFilters()"><i class="fas fa-times"></i> Clear All Filters</button>
            </div>
            <div class="studio-list-header"><h3>Studios</h3><span class="studio-count" id="studioCount">0</span></div>
            <div class="studio-list" id="studioList"><div class="studio-list-empty"><i class="fas fa-spinner fa-spin"></i><p>Loading studios...</p></div></div>
        </div>
        <div class="map-container">
            <button class="map-sidebar-toggle" id="mapSidebarToggle" onclick="toggleMapSidebar()"><i class="fas fa-list"></i></button>
            <div id="map"></div>
            <div class="map-controls">
                <button class="map-control-btn" title="View All" onclick="zoomToAll()"><i class="fas fa-expand"></i></button>
                <button class="map-control-btn" title="Zoom In" onclick="map.zoomIn()"><i class="fas fa-plus"></i></button>
                <button class="map-control-btn" title="Zoom Out" onclick="map.zoomOut()"><i class="fas fa-minus"></i></button>
            </div>
            <div class="map-loading" id="mapLoading"><i class="fas fa-spinner fa-spin"></i> Loading studios...</div>
            <div class="map-legend" id="mapLegend" style="display: none;"><div class="legend-title">Zones</div><div id="legendItems"></div></div>
        </div>
    </main>
    <script>
        const SUPABASE_URL = 'https://kvyvjwepfrqqkvyyutdw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2eXZqd2VwZnJxcWt2eXl1dGR3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyMjgyOTgsImV4cCI6MjA4MjgwNDI5OH0.ZayLxzQCEFENvQ9FwpLm4x2le2Y9kJvSslX8DVRzAh8';
        let supabaseClient, map, markerClusterGroup, allStudios = [], allBrands = [], allZones = [], filteredStudios = [], activeStudioId = null, studioMarkers = {};
        const zoneColors = ['#FA8072', '#4A90D9', '#48BB78', '#9F7AEA', '#F6AD55', '#38B2AC', '#ED64A6', '#667EEA', '#ECC94B', '#FC8181'];
        let zoneColorMap = {};
        function getBrandName(brandId) { if (!brandId) return 'Unknown'; const brand = allBrands.find(b => b.id === brandId); return brand ? brand.name : 'Unknown'; }
        function getZoneName(zoneId) { if (!zoneId) return null; const zone = allZones.find(z => z.id === zoneId); return zone ? (zone.name || zone.zone_name || zone.title) : null; }
        function getZoneForStudio(studio) { if (!studio.brand_id) return null; const brand = allBrands.find(b => b.id === studio.brand_id); return brand?.zone_id ? getZoneName(brand.zone_id) : null; }
        function getZoneIdForStudio(studio) { if (!studio.brand_id) return null; const brand = allBrands.find(b => b.id === studio.brand_id); return brand?.zone_id; }
        document.addEventListener('DOMContentLoaded', () => { supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); setupSidebar(); setupFilterListeners(); initMap(); loadData(); });
        function setupSidebar() { const sidebar = document.getElementById('sidebar'); const toggle = document.getElementById('sidebarToggle'); const overlay = document.getElementById('sidebarOverlay'); toggle.addEventListener('click', () => { sidebar.classList.toggle('collapsed'); setTimeout(() => map.invalidateSize(), 300); }); overlay.addEventListener('click', () => sidebar.classList.add('collapsed')); document.getElementById('logoutBtn').addEventListener('click', () => { if (confirm('Logout?')) window.location.href = 'login.html'; }); }
        function toggleMapSidebar() { document.getElementById('mapSidebar').classList.toggle('open'); }
        function setupFilterListeners() { document.getElementById('zoneFilter').addEventListener('change', onZoneChange); document.getElementById('brandFilter').addEventListener('change', onBrandChange); document.getElementById('stateFilter').addEventListener('change', onStateChange); document.getElementById('cityFilter').addEventListener('change', applyFilters); document.getElementById('searchInput').addEventListener('input', applyFilters); }
        function initMap() { map = L.map('map', { center: [39.8283, -98.5795], zoom: 4, maxZoom: 19, zoomControl: false }); L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '© OpenStreetMap, © CARTO', maxZoom: 20 }).addTo(map); markerClusterGroup = L.markerClusterGroup({ maxClusterRadius: 50, iconCreateFunction: function(cluster) { const count = cluster.getChildCount(); let size = count > 25 ? 'large' : count > 10 ? 'medium' : 'small'; return L.divIcon({ html: '<div>' + count + '</div>', className: 'marker-cluster marker-cluster-' + size, iconSize: L.point(40, 40) }); } }); map.addLayer(markerClusterGroup); }
        async function loadData() { try { try { const { data: zones } = await supabaseClient.from('zones').select('*'); allZones = zones || []; } catch(e) { document.getElementById('zoneFilterGroup').style.display = 'none'; } try { const { data: brands } = await supabaseClient.from('brands').select('*').order('name'); allBrands = brands || []; } catch(e) { document.getElementById('brandFilterGroup').style.display = 'none'; } const { data: studios } = await supabaseClient.from('studios').select('*'); allStudios = studios || []; setupZoneColors(); populateZoneDropdown(); populateBrandDropdown(); populateStateDropdown(); populateCityDropdown(); geocodeStudios(); document.getElementById('mapLoading').style.display = 'none'; applyFilters(); } catch (error) { document.getElementById('mapLoading').innerHTML = '<i class="fas fa-exclamation-circle"></i> Error loading'; } }
        function setupZoneColors() { allZones.forEach((z, i) => { zoneColorMap[z.id] = zoneColors[i % zoneColors.length]; }); if (allZones.length > 0) { document.getElementById('legendItems').innerHTML = allZones.map(z => '<div class="legend-item"><div class="legend-color" style="background:' + zoneColorMap[z.id] + '"></div><span>' + (z.name || z.zone_name || z.title) + '</span></div>').join(''); document.getElementById('mapLegend').style.display = 'block'; } }
        function populateZoneDropdown() { const sel = document.getElementById('zoneFilter'); sel.innerHTML = '<option value="">All Zones</option>'; allZones.forEach(z => { const cnt = allStudios.filter(s => getZoneIdForStudio(s) === z.id).length; sel.innerHTML += '<option value="' + z.id + '">' + (z.name || z.zone_name || z.title) + ' (' + cnt + ')</option>'; }); if (!allZones.length) document.getElementById('zoneFilterGroup').style.display = 'none'; }
        function populateBrandDropdown(brands) { const sel = document.getElementById('brandFilter'); const list = brands || allBrands; sel.innerHTML = '<option value="">All Brands</option>'; list.forEach(b => { const cnt = allStudios.filter(s => s.brand_id === b.id).length; sel.innerHTML += '<option value="' + b.id + '">' + b.name + ' (' + cnt + ')</option>'; }); if (!allBrands.length) document.getElementById('brandFilterGroup').style.display = 'none'; }
        function populateStateDropdown(studios) { const sel = document.getElementById('stateFilter'); const list = studios || allStudios; const cnts = {}; list.forEach(s => { if (s.state) cnts[s.state] = (cnts[s.state] || 0) + 1; }); sel.innerHTML = '<option value="">All States</option>'; Object.keys(cnts).sort().forEach(st => { sel.innerHTML += '<option value="' + st + '">' + st + ' (' + cnts[st] + ')</option>'; }); }
        function populateCityDropdown(studios) { const sel = document.getElementById('cityFilter'); const list = studios || allStudios; const cnts = {}; list.forEach(s => { if (s.city) cnts[s.city] = (cnts[s.city] || 0) + 1; }); sel.innerHTML = '<option value="">All Cities</option>'; Object.keys(cnts).sort().forEach(c => { sel.innerHTML += '<option value="' + c + '">' + c + ' (' + cnts[c] + ')</option>'; }); }
        function onZoneChange() { const zoneId = document.getElementById('zoneFilter').value; if (allBrands.length) { populateBrandDropdown(zoneId ? allBrands.filter(b => b.zone_id === zoneId) : null); document.getElementById('brandFilter').value = ''; } updateStateAndCityDropdowns(); applyFilters(); }
        function onBrandChange() { updateStateAndCityDropdowns(); applyFilters(); }
        function onStateChange() { updateCityDropdown(); applyFilters(); }
        function updateStateAndCityDropdowns() { const zoneId = document.getElementById('zoneFilter').value; const brandId = document.getElementById('brandFilter').value; let studios = [...allStudios]; if (zoneId && allBrands.length) { const zBrands = allBrands.filter(b => b.zone_id === zoneId).map(b => b.id); studios = studios.filter(s => zBrands.includes(s.brand_id)); } if (brandId) studios = studios.filter(s => s.brand_id === brandId); populateStateDropdown(studios); document.getElementById('stateFilter').value = ''; populateCityDropdown(studios); document.getElementById('cityFilter').value = ''; }
        function updateCityDropdown() { const zoneId = document.getElementById('zoneFilter').value; const brandId = document.getElementById('brandFilter').value; const state = document.getElementById('stateFilter').value; let studios = [...allStudios]; if (zoneId && allBrands.length) { const zBrands = allBrands.filter(b => b.zone_id === zoneId).map(b => b.id); studios = studios.filter(s => zBrands.includes(s.brand_id)); } if (brandId) studios = studios.filter(s => s.brand_id === brandId); if (state) studios = studios.filter(s => s.state === state); populateCityDropdown(studios); document.getElementById('cityFilter').value = ''; }
        function clearAllFilters() { document.getElementById('zoneFilter').value = ''; document.getElementById('brandFilter').value = ''; document.getElementById('stateFilter').value = ''; document.getElementById('cityFilter').value = ''; document.getElementById('searchInput').value = ''; populateBrandDropdown(); populateStateDropdown(); populateCityDropdown(); applyFilters(); }
        function geocodeStudios() { const coords = { 'lehi': [40.3916, -111.8508], 'provo': [40.2338, -111.6585], 'salt lake city': [40.7608, -111.891], 'orem': [40.2969, -111.6946], 'sandy': [40.5649, -111.8389], 'draper': [40.5247, -111.8638], 'american fork': [40.3769, -111.7957], 'pleasant grove': [40.3641, -111.7385], 'spanish fork': [40.1149, -111.6549], 'springville': [40.1652, -111.6107], 'saratoga springs': [40.3493, -111.9046], 'eagle mountain': [40.3144, -112.0097], 'herriman': [40.5141, -112.033], 'south jordan': [40.5621, -111.9296], 'west jordan': [40.6097, -111.9391], 'riverton': [40.5219, -111.9391], 'taylorsville': [40.6677, -111.9388], 'murray': [40.6669, -111.8879], 'midvale': [40.6111, -111.8999], 'cottonwood heights': [40.6197, -111.8102], 'holladay': [40.6688, -111.8246], 'bountiful': [40.8894, -111.8808], 'layton': [41.0602, -111.9711], 'ogden': [41.223, -111.9738], 'st. george': [37.0965, -113.5684], 'st george': [37.0965, -113.5684], 'logan': [41.737, -111.8338], 'austin': [30.2672, -97.7431], 'houston': [29.7604, -95.3698], 'dallas': [32.7767, -96.797], 'phoenix': [33.4484, -112.074], 'denver': [39.7392, -104.9903], 'las vegas': [36.1699, -115.1398] }; const stateCenters = { 'ut': [39.32, -111.0937], 'utah': [39.32, -111.0937], 'tx': [31.9686, -99.9018], 'az': [34.0489, -111.0937], 'co': [39.5501, -105.7821], 'nv': [38.8026, -116.4194] }; allStudios.forEach(s => { if (s.latitude && s.longitude) return; const c = s.city?.toLowerCase(); const st = s.state?.toLowerCase(); const loc = coords[c] || stateCenters[st] || [39.8283, -98.5795]; s.latitude = loc[0] + (Math.random() - 0.5) * 0.015; s.longitude = loc[1] + (Math.random() - 0.5) * 0.015; }); }
        function applyFilters() { const zoneId = document.getElementById('zoneFilter').value; const brandId = document.getElementById('brandFilter').value; const state = document.getElementById('stateFilter').value; const city = document.getElementById('cityFilter').value; const search = document.getElementById('searchInput').value.toLowerCase().trim(); filteredStudios = allStudios.filter(s => { if (!s.latitude || !s.longitude) return false; if (zoneId && getZoneIdForStudio(s) !== zoneId) return false; if (brandId && s.brand_id !== brandId) return false; if (state && s.state !== state) return false; if (city && s.city !== city) return false; if (search && ![getBrandName(s.brand_id), s.city, s.state, s.address].join(' ').toLowerCase().includes(search)) return false; return true; }); updateMap(filteredStudios); updateStudioList(filteredStudios); document.getElementById('studioCount').textContent = filteredStudios.length; }
        function updateMap(studios) { markerClusterGroup.clearLayers(); studioMarkers = {}; studios.forEach(s => { const color = zoneColorMap[getZoneIdForStudio(s)] || '#FA8072'; const icon = L.divIcon({ html: '<div style="width:20px;height:20px;background:' + color + ';border:3px solid white;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>', className: 'custom-marker', iconSize: [20, 20], iconAnchor: [10, 10], popupAnchor: [0, -10] }); const marker = L.marker([s.latitude, s.longitude], { icon }).bindPopup(createPopupContent(s)).bindTooltip(getBrandName(s.brand_id) + ' - ' + s.city, { direction: 'top', offset: [0, -10] }).on('click', () => setActiveStudio(s.id)); markerClusterGroup.addLayer(marker); studioMarkers[s.id] = marker; }); if (studios.length) zoomToAll(); }
        function updateStudioList(studios) { const el = document.getElementById('studioList'); if (!studios.length) { el.innerHTML = '<div class="studio-list-empty"><i class="fas fa-map-marker-alt"></i><p>No studios found</p></div>'; return; } el.innerHTML = studios.map(s => { const color = zoneColorMap[getZoneIdForStudio(s)] || '#FA8072'; const price = s.monthly_rate ? '30-min: ' + s.monthly_rate : ''; return '<div class="studio-list-item' + (activeStudioId === s.id ? ' active' : '') + '" onclick="selectStudio(\'' + s.id + '\')" id="list-item-' + s.id + '"><div class="studio-list-item-header"><div class="studio-list-item-dot" style="background:' + color + '"></div><div class="studio-list-item-name">' + getBrandName(s.brand_id) + '</div></div><div class="studio-list-item-location">' + (s.city || '') + (s.state ? ', ' + s.state : '') + '</div>' + (price ? '<div class="studio-list-item-price">' + price + '</div>' : '') + '</div>'; }).join(''); }
        function selectStudio(id) { setActiveStudio(id); const m = studioMarkers[id]; if (m) markerClusterGroup.zoomToShowLayer(m, () => m.openPopup()); if (window.innerWidth <= 768) document.getElementById('mapSidebar').classList.remove('open'); }
        function setActiveStudio(id) { activeStudioId = id; document.querySelectorAll('.studio-list-item').forEach(el => el.classList.remove('active')); const el = document.getElementById('list-item-' + id); if (el) { el.classList.add('active'); el.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } }
        function createPopupContent(s) { const zone = getZoneForStudio(s); const brand = getBrandName(s.brand_id); const addr = [s.address, s.city, s.state].filter(Boolean).join(', '); const mapsUrl = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(addr); return '<div class="popup-header"><div class="popup-title">' + brand + '</div>' + (zone ? '<span class="popup-zone">' + zone + '</span>' : '') + '</div><div class="popup-body">' + (s.address ? '<div class="popup-info-row"><i class="fas fa-location-dot"></i><span>' + s.address + (s.city ? ', ' + s.city : '') + (s.state ? ', ' + s.state : '') + '</span></div>' : '') + (s.phone_number ? '<div class="popup-info-row"><i class="fas fa-phone"></i><span>' + s.phone_number + '</span></div>' : '') + (s.monthly_rate ? '<div class="popup-info-row"><i class="fas fa-dollar-sign"></i><span>30-min: ' + s.monthly_rate + '</span></div>' : '') + '</div><div class="popup-actions" style="display:flex;gap:0.5rem;flex-wrap:wrap;"><button onclick="zoomToStudio(' + s.latitude + ',' + s.longitude + ')" class="popup-btn popup-btn-secondary" style="flex:1;min-width:45%;border:none;cursor:pointer;"><i class="fas fa-search-plus"></i> Zoom In</button><a href="' + mapsUrl + '" target="_blank" class="popup-btn popup-btn-secondary" style="flex:1;min-width:45%;"><i class="fas fa-map-marker-alt"></i> Google Maps</a><a href="teamstudio-directory.html?studio=' + s.id + '" class="popup-btn" style="flex:1;min-width:100%;"><i class="fas fa-info-circle"></i> View Details</a></div>'; }
        function zoomToAll() { if (filteredStudios.length) { const b = markerClusterGroup.getBounds(); if (b.isValid()) map.fitBounds(b.pad(0.1), { animate: true, duration: 0.5 }); } else { map.setView([39.8283, -98.5795], 4, { animate: true }); } }
        function zoomToStudio(lat, lng) { map.setView([lat, lng], 18, { animate: true, duration: 0.5 }); }
    </script>
</body>
</html>
